<div class="card">
  <!--begin::Card body-->
  <span
    class="spinner-border spinner-border-sm align-middle ms-2"
    *ngIf="isLoading$ | async"
  ></span>
  <div class="card-body border-top p-9">
    <div class="row mb-6">
      <div class="col-lg-8 fv-row fv-plugins-icon-container">
        <label class="fw-semibold fs-6 py-2">Titulo: (*)</label>
        <input
          type="text"
          name="title"
          [(ngModel)]="title"
          class="form-control form-control-lg form-control-solid"
          placeholder="Por ejemplo: Los mejores funkos de la city"
          spellcheck="false"
          data-ms-editor="true"
        />
      </div>
      <div class="col-lg-4 fv-row fv-plugins-icon-container">
        <label class="fw-semibold fs-6 py-2">Sku</label>
        <input
          type="text"
          name="sku"
          [(ngModel)]="sku"
          class="form-control form-control-lg form-control-solid"
          placeholder="Por ejemplo: ASJD123"
          spellcheck="false"
          data-ms-editor="true"
        />
      </div>
    </div>
    <div class="row mb-6">
      <div class="col-lg-4 fv-row fv-plugins-icon-container">
        <label class="fw-semibold fs-6 py-2">Precio ARS: (*)</label>
        <input
          type="number"
          name="price_ars"
          [(ngModel)]="price_ars"
          class="form-control form-control-lg form-control-solid"
          placeholder="Por ejemplo: 1000"
          spellcheck="false"
          data-ms-editor="true"
        />
      </div>
      <div class="col-lg-4 fv-row fv-plugins-icon-container">
        <label class="fw-semibold fs-6 py-2">Precio USD</label>
        <input
          type="number"
          name="price_usd"
          [(ngModel)]="price_usd"
          class="form-control form-control-lg form-control-solid"
          placeholder="Por ejemplo: 1"
          spellcheck="false"
          data-ms-editor="true"
        />
      </div>
      <div class="col-lg-4 fv-row fv-plugins-icon-container">
        <label class="fw-semibold fs-6 py-2">Marcas:</label>
        <select
          name="marca"
          class="form-control form-select-solid fw-bolder"
          placeholder="Seleccionar Marca"
          [(ngModel)]="marca_id"
        >
          <option value="">Select</option>
          <ng-container *ngFor="let item of marcas">
            <option [value]="item.id">{{ item.name }}</option>
          </ng-container>
        </select>
      </div>
    </div>

    <div class="row mb-6">
      <div class="col-4">
        <label class="fw-semibold fs-6 py-2"
          >Departamento: (Primer Nivel)</label
        >
        <select
          name="departament"
          class="form-control form-select-solid fw-bolder"
          placeholder="Seleccionar Departamento"
          [(ngModel)]="categorie_first_id"
          (change)="changeDepartamento()"
        >
          <option value="">Select</option>
          <ng-container *ngFor="let item of categorie_first">
            <option [value]="item.id">{{ item.name }}</option>
          </ng-container>
        </select>
      </div>
      <div class="col-4">
        <label class="fw-semibold fs-6 py-2">Categoria: (Opcional)</label>
        <select
          class="form-control form-select-solid fw-bolder"
          name="categorie"
          placeholder="Seleccionar categoria"
          [(ngModel)]="categorie_second_id"
          (change)="changeCategorie()"
        >
          <option value="">Select</option>
          <ng-container *ngFor="let item of categorie_seconds_backups">
            <option [value]="item.id">{{ item.name }}</option>
          </ng-container>
        </select>
      </div>
      <div class="col-4">
        <label class="fw-semibold fs-6 py-2">Sub Categoria: (Opcional)</label>
        <select
          class="form-control form-select-solid fw-bolder"
          name="categorie"
          placeholder="Seleccionar categoria"
          [(ngModel)]="categorie_third_id"
        >
          <option value="">Select</option>
          <ng-container *ngFor="let item of categorie_thirds_backups">
            <option [value]="item.id">{{ item.name }}</option>
          </ng-container>
        </select>
      </div>
    </div>

    <div class="row mb-6">
      <div class="col-lg-4 col-md-4 col-sm-12 my-2">
        <label class="fw-semibold fs-6 py-2">Word: (*)</label>
        <input
          type="text"
          name="word"
          [(ngModel)]="word"
          (keyup.enter)="addItems()"
          class="form-control form-control-lg form-control-solid"
          placeholder="Por ejemplo: XXXXX"
          spellcheck="false"
          data-ms-editor="true"
        />
      </div>

      <div class="col-lg-6 col-md-6 col-sm-12 my-2" *ngIf="!isShowMultiselect">
        <label class="fw-semibold fs-6 py-2">Tags:</label>
        <ng-multiselect-dropdown
          [placeholder]="'tags'"
          [settings]="dropdownSettings"
          [data]="dropdownList"
          [(ngModel)]="selectedItemsTags"
          (onSelect)="onItemSelect($event)"
          (onSelectAll)="onSelectAll($event)"
        >
        </ng-multiselect-dropdown>
      </div>
      <div class="col-3">
  <label class="required fw-bold fs-6 mb-2">Selecciona un estado</label>
  <select
    name="state"
    class="form-control form-select-solid fw-bolder"
    [(ngModel)]="state"
  >
    <option [ngValue]="1">Pendiente</option>
    <option [ngValue]="2">Public</option>
  </select>
</div>

<div class="col-3">
  <label class="required fw-bold fs-6 mb-2">
    Seleccionar envío
  </label>
  <select
    name="cost"
    class="form-control form-select-solid fw-bolder"
    [(ngModel)]="cost"
  >
    <option [ngValue]="1">Gratis</option>
    <option [ngValue]="2">No gratis</option>
  </select>
</div>


    <div class="row mb-6">
      <div class="col-lg-6 col-md-6 col-sm-12 my-2">
        <label class="form-label">Subir Imagen (Tamaño: 200 * 150): </label>
        <div class="custom-file">
          <input
            type="file"
            class="custom-file-input"
            id="customFile"
            accept=".jpeg, .bmp, .png, .jpg, .gif, .webp"
            (change)="processFile($event)"
          />
          <label class="custom-file-label" for="customFile"
            >Seleccionar Archivo</label
          >
        </div>
        <div class="img py-4">
          <img [src]="imagen_previsualizacion" width="200" alt="" />
        </div>
      </div>
      <div class="col-lg-6 col-md-6 col-sm-12 my-2">
        <div class="row">
          <div class="col-8">
            <label class="form-label">Subir tus Imagenes: </label>
            <div class="custom-file">
              <input
                type="file"
                class="custom-file-input"
                id="customFileOImagenes"
                accept=".jpeg, .bmp, .png, .jpg, .gif, .webp"
                (change)="processFileTwo($event)"
              />
              <label class="custom-file-label" for="customFileOImagenes"
                >Seleccionar Archivo</label
              >
            </div>
            <div class="img py-4">
              <img [src]="imagen_add_previsualiza" width="100" alt="" />
            </div>
          </div>
          <div class="col-4">
            <button class="btn btn-primary btn-sm" (click)="addImagen()">
              +
            </button>
          </div>

          <div class="col-12">
            <div
              id="kt_table_users_wrapper"
              class="dataTables_wrapper dt-bootstrap4 no-footer"
            >
              <div class="table-responsive w-100">
                <table
                  class="table align-middle table-row-dashed fs-6 gy-5 dataTable no-footer"
                  id="kt_advance_table_widget_1"
                >
                  <thead>
                    <tr class="text-left">
                      <th>IMAGEN</th>
                      <th>ACCIÓN</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let imagen_ of images_files; let i = index">
                      <td>
                        <img [src]="imagen_.imagen" width="50" alt="" />
                      </td>
                      <td>
                        <button
                          class="ml-5 btn btn-sm btn-danger"
                          (click)="removeImages(imagen_.id)"
                        >
                          X
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row mb-6">
      <div class="col-lg-8 fv-row fv-plugins-icon-container">
        <label class="fs-6 fw-semibold mb-2">Descripcion: </label>
        <ckeditor
          [(ngModel)]="description"
          (change)="onDescriptionChange($event)"
        ></ckeditor>
      </div>
      <div class="col-lg-4 fv-row fv-plugins-icon-container">
        <div class="row">
          <div class="col-12">
            <label class="fs-6 fw-semibold mb-2">Resumen: </label>
            <textarea
              class="form-control form-control-solid"
              rows="3"
              name="resumen"
              [(ngModel)]="resumen"
              placeholder="*****"
            ></textarea>
          </div>
          <div class="col-12">
            <!-- <label class="fs-6 fw-semibold mb-2">Stock: </label>
            <input
              type="number"
              name="stock"
              [(ngModel)]="stock"
              class="form-control form-control-lg form-control-solid"
              placeholder="Por ejemplo: 20"
            /> -->
            <!-- DESPUÉS (solo lectura) -->
          <div class="fv-row mb-7">
            <label class="fs-6 fw-bold mb-2">Stock Actual</label>
            <input
              type="number"
              class="form-control form-control-solid"
              [(ngModel)]="stock"
              [disabled]="true"
              readonly>
            <div class="form-text">
              El stock se gestiona mediante movimientos de inventario.
              <a href="javascript:void(0)" (click)="toggleStockSection()">
                Ir a Gestión de Stock
              </a>
            </div>
          </div>
          </div>
          <!-- SECCIÓN DE GESTIÓN DE STOCK -->
        </div>
      </div>
      <div class="card card-flush mt-6">
        <div class="card-header">
          <h3 class="card-title">
            Gestión de Stock
          </h3>
          <div class="card-toolbar">
            <button
              type="button"
              class="btn btn-sm btn-light-primary"
              (click)="toggleStockSection()">
              <i class="bi" [class.bi-chevron-down]="!showStockSection" [class.bi-chevron-up]="showStockSection"></i>
              {{ showStockSection ? 'Ocultar' : 'Mostrar' }} Detalles
            </button>
          </div>
        </div>

        <div class="card-body pt-0" *ngIf="showStockSection">
          <!-- Resumen de Stock -->
          <div class="row g-5 mb-7" *ngIf="stock_summary">
            <div class="col-sm-6 col-xl-3">
              <div class="card card-flush h-100">
                <div class="card-body p-5">
                  <div class="fs-6 fw-semibold text-gray-500">Stock Actual</div>
                  <div class="d-flex align-items-center">
                    <span class="fs-2hx fw-bold text-gray-900 me-2">{{ stock }}</span>
                    <span class="badge badge-light-success fs-base">
                      <i class="ki-duotone ki-arrow-up fs-5 text-success ms-n1"></i>
                      Unidades
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-sm-6 col-xl-3">
              <div class="card card-flush h-100">
                <div class="card-body p-5">
                  <div class="fs-6 fw-semibold text-gray-500">Total Ingresos</div>
                  <div class="fs-2hx fw-bold text-success">+{{ stock_summary.total_ingresos }}</div>
                </div>
              </div>
            </div>

            <div class="col-sm-6 col-xl-3">
              <div class="card card-flush h-100">
                <div class="card-body p-5">
                  <div class="fs-6 fw-semibold text-gray-500">Total Egresos</div>
                  <div class="fs-2hx fw-bold text-danger">-{{ stock_summary.total_egresos }}</div>
                </div>
              </div>
            </div>

            <div class="col-sm-6 col-xl-3">
              <div class="card card-flush h-100">
                <div class="card-body p-5">
                  <div class="fs-6 fw-semibold text-gray-500">Total Movimientos</div>
                  <div class="fs-2hx fw-bold text-gray-900">{{ stock_summary.total_movements }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Formulario de Nuevo Movimiento -->
          <div class="separator separator-dashed my-6"></div>

          <h4 class="mb-5">Registrar Movimiento de Stock</h4>

          <div class="row g-5 mb-7">
            <div class="col-md-3">
              <label class="form-label required">Tipo de Movimiento</label>
              <select
                class="form-select form-select-solid"
                [(ngModel)]="movement_type">
                <option value="ingreso">Ingreso</option>
                <option value="egreso">Egreso</option>
                <option value="ajuste">Ajuste de Inventario</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label required">
                {{ movement_type === 'ajuste' ? 'Nuevo Stock Total' : 'Cantidad' }}
              </label>
              <input
                type="number"
                class="form-control form-control-solid"
                [(ngModel)]="movement_quantity"
                min="0"
                [placeholder]="movement_type === 'ajuste' ? 'Ej: 100' : 'Ej: 50'">
            </div>

            <div class="col-md-3">
              <label class="form-label">Referencia</label>
              <input
                type="text"
                class="form-control form-control-solid"
                [(ngModel)]="movement_reference"
                placeholder="Ej: Factura #123">
            </div>

            <div class="col-md-3">
              <label class="form-label d-block">&nbsp;</label>
              <button
                type="button"
                class="btn btn-primary w-100"
                (click)="addStockMovement()">
                <i class="bi bi-plus-circle"></i>
                Registrar Movimiento
              </button>
            </div>
          </div>

          <div class="row g-5 mb-7">
            <div class="col-12">
              <label class="form-label">Descripción / Observaciones</label>
              <textarea
                class="form-control form-control-solid"
                rows="2"
                [(ngModel)]="movement_description"
                placeholder="Descripción opcional del movimiento..."></textarea>
            </div>
          </div>

          <!-- Tabla de Movimientos -->
          <div class="separator separator-dashed my-6"></div>

          <h4 class="mb-5">Historial de Movimientos</h4>

          <div class="table-responsive">
            <table class="table table-row-bordered table-row-gray-300 gy-4">
              <thead>
                <tr class="fw-bold fs-6 text-gray-800">
                  <th class="min-w-100px">Fecha</th>
                  <th class="min-w-100px">Tipo</th>
                  <th class="min-w-80px">Cantidad</th>
                  <th class="min-w-80px">Stock Anterior</th>
                  <th class="min-w-80px">Stock Nuevo</th>
                  <th class="min-w-150px">Descripción</th>
                  <th class="min-w-100px">Referencia</th>
                  <th class="min-w-120px">Usuario</th>
                  <th class="min-w-80px text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let movement of stock_movements; let i = index">
                  <td>
                    <span class="text-gray-800">{{ movement.created_at | date: 'dd/MM/yyyy HH:mm' }}</span>
                  </td>
                  <td>
                    <span
                      class="badge"
                      [ngClass]="getMovementTypeBadgeClass(movement.type)">
                      {{ getMovementTypeLabel(movement.type) }}
                    </span>
                  </td>
                  <td>
                    <span
                      class="fw-bold"
                      [class.text-success]="movement.quantity > 0"
                      [class.text-danger]="movement.quantity < 0">
                      {{ movement.quantity > 0 ? '+' : '' }}{{ movement.quantity }}
                    </span>
                  </td>
                  <td>
                    <span class="text-gray-600">{{ movement.stock_before }}</span>
                  </td>
                  <td>
                    <span class="text-gray-800 fw-bold">{{ movement.stock_after }}</span>
                  </td>
                  <td>
                    <span class="text-gray-600">{{ movement.description || '-' }}</span>
                  </td>
                  <td>
                    <span class="text-gray-600">{{ movement.reference || '-' }}</span>
                  </td>
                  <td>
                    <span class="text-gray-800" *ngIf="movement.user">
                      {{ movement.user.name }}
                    </span>
                    <span class="text-gray-400" *ngIf="!movement.user">
                      Sistema
                    </span>
                  </td>
                  <td class="text-end">
                    <button
                      *ngIf="i === 0"
                      type="button"
                      class="btn btn-sm btn-icon btn-light-danger"
                      (click)="deleteStockMovement(movement)"
                      title="Eliminar último movimiento">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="stock_movements.length === 0">
                  <td colspan="9" class="text-center text-gray-500 py-8">
                    No hay movimientos de stock registrados
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="row mb-6">
      <div class="col-3">
        <button class="btn btn-primary" (click)="save()">Guardar</button>
      </div>
    </div>
  </div>
</div>
